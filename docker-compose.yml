services:
  agent:
    build:
      context: .
      dockerfile: Dockerfile-agent
    container_name: claudeforge-agent
    volumes:
      - ~/code:/projects:rw
      - agent-data:/app/data
    ports:
      - "8000:8000"
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - CLAUDE_MODEL_OPUS=${CLAUDE_MODEL_OPUS:-claude-3-opus-20240229}
      - CLAUDE_MODEL_SONNET=${CLAUDE_MODEL_SONNET:-claude-3-5-sonnet-20241022}
      - CLAUDE_MODEL_HAIKU=${CLAUDE_MODEL_HAIKU:-claude-3-haiku-20240307}
      - DATABASE_PATH=/app/data/db.sqlite
      - PROJECTS_PATH=/projects
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - claudeforge-net
    restart: unless-stopped

  dashboard:
    build:
      context: .
      dockerfile: Dockerfile-dashboard
    container_name: claudeforge-dashboard
    ports:
      - "5050:5050"
    environment:
      - PORT=5050
      - API_URL=http://agent:8000
      - PUBLIC_API_URL=http://localhost:8000
    depends_on:
      agent:
        condition: service_healthy
    networks:
      - claudeforge-net
    restart: unless-stopped

networks:
  claudeforge-net:
    driver: bridge

volumes:
  agent-data:
